<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•”ê¸°ì¥ </title>
    <style>
        /* ë³€ìˆ˜ ì„¤ì • */
        :root { --primary: #4f46e5; --bg: #f8fafc; --card: #ffffff; --text: #334155; --success: #22c55e; --error: #ef4444; }
        
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë° ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .container { width: 100%; max-width: 600px; background: var(--card); padding: 2rem; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        h1, h2 { text-align: center; color: #1e293b; margin-bottom: 10px; }
        
        /* Inputs & Buttons */
        input, textarea { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        .btn { display: block; width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); margin-top: 5px; }
        
        /* Quiz UI */
        .quiz-status { display: flex; justify-content: space-between; color: #64748b; font-size: 0.9rem; margin-bottom: 20px; }
        .question-box { font-size: 1.4rem; font-weight: bold; text-align: center; margin: 30px 0; word-break: keep-all; }
        
        .feedback-area { 
            margin-top: 20px; 
            padding: 15px; 
            border-radius: 8px; 
            text-align: center; 
            min-height: 50px; 
        }
        
        .feedback-area.correct { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .feedback-area.wrong { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .correct-answer-display { font-weight: bold; font-size: 1.1rem; margin-top: 5px; }

        /* Helpers */
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <div id="setup-view">
        <h1>ğŸ”— êµ¬ê¸€ ì‹œíŠ¸ ì—°ê²°</h1>
        <p style="text-align:center; color:#64748b; font-size:0.9rem;">ì‹œíŠ¸ ê³µìœ  ì„¤ì •ì„ 'ê³µê°œ'ë¡œ ë°”ê¾¸ê³ , ì‹œíŠ¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
        <input type="text" id="sheet-id-input" placeholder="ì—¬ê¸°ì— ì‹œíŠ¸ IDë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”">
        <button class="btn" onclick="saveSheetId()">âœ”ï¸ ì‹œíŠ¸ ID ì €ì¥</button>
        <div id="current-sheet-status" style="margin-top:15px; text-align:center; color:#10b981; font-weight:bold;"></div>

        <h2 style="margin-top:40px;">ğŸ”¥ í€´ì¦ˆ ì‹œì‘</h2>
        <button class="btn" style="background:#10b981;" onclick="loadAndStartQuiz()">ë°ì´í„° ë¡œë“œ ë° ì•”ê¸° ì‹œì‘</button>
        
        <p style="margin-top:20px; border-top:1px solid #e2e8f0; padding-top:10px; text-align:center; font-size:0.9rem;">
            <a href="https://docs.google.com/spreadsheets/d/148tD5R801q1J1nL_Yj2nE-o-T2hE7f8y/edit#gid=0" target="_blank">ì˜ˆì‹œ ì‹œíŠ¸ ë³´ê¸°</a>
        </p>
    </div>
    
    <div id="loading-view" class="hidden" style="text-align:center; margin-top:50px;">
        <h2 id="loading-message">ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</h2>
        <div class="loader" style="margin-top:20px;"></div>
    </div>

    <div id="quiz-view" class="hidden">
        <div class="quiz-status">
            <span>ë‚¨ì€ ë¬¸ì œ: <b id="remain-count">0</b></span>
            <span class="badge" id="round-badge">1ë¼ìš´ë“œ</span>
        </div>

        <div class="question-box" id="question-display"></div>

        <input type="text" id="quiz-input" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off" onkeypress="handleEnter(event, 'submit')">
        
        <button class="btn" id="btn-submit" onclick="submitAnswer()">ì œì¶œ</button>
        <button class="btn hidden" id="btn-next" onclick="nextQuestion()">ë‹¤ìŒ ë¬¸ì œ â¡ï¸</button>

        <div id="feedback" class="feedback-area hidden">
            <div id="feedback-msg"></div>
            <div id="correct-answer-show" class="correct-answer-display"></div>
        </div>
    </div>

    <div id="finish-view" class="hidden" style="text-align:center;">
        <h1 style="font-size:3rem; margin-bottom:0;">ğŸ‰</h1>
        <h2>ì™„ë²½í•˜ê²Œ ì•”ê¸°í–ˆìŠµë‹ˆë‹¤!</h2>
        <p>í‹€ë¦° ë¬¸ì œ ì—†ì´ ëª¨ë“  ê³¼ì •ì„ í†µê³¼í•˜ì…¨ìŠµë‹ˆë‹¤.</p>
        <button class="btn" onclick="location.reload()">ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
</div>

<script>
    // ë°ì´í„° ì €ì¥ì†Œ
    let allQuestions = []; 
    let quizQueue = [];    
    let retryQueue = [];   
    let currentQ = null;   
    let round = 1;
    let sheetId = '';
    const STORAGE_KEY = 'SpartaSheetId';

    // --- 1. ì´ˆê¸°í™” ë° ID ë¡œë“œ ---
    window.onload = function() {
        // ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ì‹œíŠ¸ ID ë¡œë“œ
        const savedId = localStorage.getItem(STORAGE_KEY);
        if (savedId) {
            sheetId = savedId;
            document.getElementById('sheet-id-input').value = savedId;
            document.getElementById('current-sheet-status').innerText = 'âœ… ì‹œíŠ¸ IDê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
        }
    };

    function saveSheetId() {
        const id = document.getElementById('sheet-id-input').value.trim();
        if(!id) return alert("ì‹œíŠ¸ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        sheetId = id.includes('/d/') ? id.split('/d/')[1].split('/')[0] : id; // ì „ì²´ URLì´ ë“¤ì–´ì™€ë„ IDë§Œ ì¶”ì¶œ
        localStorage.setItem(STORAGE_KEY, sheetId);
        document.getElementById('current-sheet-status').innerText = 'âœ… ì‹œíŠ¸ IDê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
    }

    // --- 2. Sheets ë°ì´í„° ë¡œë“œ ---
    async function loadAndStartQuiz() {
        if(!sheetId) {
            alert("ì‹œíŠ¸ IDë¥¼ ë¨¼ì € ì €ì¥í•´ì£¼ì„¸ìš”!");
            return;
        }

        // ë¡œë”© í™”ë©´ í‘œì‹œ
        document.getElementById('setup-view').classList.add('hidden');
        document.getElementById('loading-view').classList.remove('hidden');
        document.getElementById('loading-message').innerText = 'ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...';

        // Google Sheets API URL (Sheet1ì˜ Aì—´ê³¼ Bì—´ ë°ì´í„°)
        const sheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&tq=SELECT%20A%2C%20B`;

        try {
            const response = await fetch(sheetUrl);
            const dataText = await response.text();
            
            // JSONP í˜•ì‹ì˜ ì‘ë‹µì„ JSON ê°ì²´ë¡œ íŒŒì‹±
            const jsonText = dataText.substring(dataText.indexOf('{'), dataText.lastIndexOf('}') + 1);
            const data = JSON.parse(jsonText);

            // ë°ì´í„° ì¶”ì¶œ
            const rows = data.table.rows;
            allQuestions = [];
            
            // ì²« ë²ˆì§¸ í–‰ì€ í—¤ë”ì´ë¯€ë¡œ ìŠ¤í‚µ
            for (let i = 1; i < rows.length; i++) {
                const q = rows[i].c[0]?.v; // Aì—´ (ë¬¸ì œ)
                const a = rows[i].c[1]?.v; // Bì—´ (ì •ë‹µ)
                
                if (q && a) {
                    allQuestions.push({ q: q.toString().trim(), a: a.toString().trim() });
                }
            }

            if (allQuestions.length === 0) {
                throw new Error("ì‹œíŠ¸ì—ì„œ ìœ íš¨í•œ ë¬¸ì œ-ì •ë‹µ ìŒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹œíŠ¸ê°€ ë¹„ì–´ ìˆê±°ë‚˜ ê³µìœ  ì„¤ì •ì´ ì˜ëª»ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            }

            // ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê³  í€´ì¦ˆ ì‹œì‘
            document.getElementById('loading-view').classList.add('hidden');
            startQuizInit();

        } catch (error) {
            console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", error);
            document.getElementById('loading-message').innerText = `âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;
            document.getElementById('setup-view').classList.remove('hidden');
            document.getElementById('loading-view').classList.add('hidden');
            alert("ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì‹œíŠ¸ IDì™€ 'ê³µê°œ ê³µìœ  ì„¤ì •'ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }
    }

    // --- 3. í€´ì¦ˆ ë¡œì§ (ë™ì¼) ---
    function handleEnter(e, type) {
        if(e.key === 'Enter') {
            if(type === 'submit') submitAnswer();
        }
    }

    function startQuizInit() {
        if(allQuestions.length === 0) return alert("ë°ì´í„° ì—†ìŒ");
        
        quizQueue = [...allQuestions]; 
        retryQueue = [];
        round = 1;

        document.getElementById('setup-view').classList.add('hidden');
        document.getElementById('quiz-view').classList.remove('hidden');
        
        loadNextQuestion();
    }

    function loadNextQuestion() {
        // íê°€ ë¹„ì—ˆìœ¼ë©´ ë¼ìš´ë“œ ì²´í¬
        if(quizQueue.length === 0) {
            if(retryQueue.length === 0) {
                // ì™„ì „ ì¢…ë£Œ
                document.getElementById('quiz-view').classList.add('hidden');
                document.getElementById('finish-view').classList.remove('hidden');
                return;
            } else {
                // ë‹¤ìŒ ë¼ìš´ë“œ ì‹œì‘ (í‹€ë¦° ë¬¸ì œë§Œ ë‹¤ì‹œ)
                quizQueue = [...retryQueue];
                retryQueue = [];
                round++;
                alert(`ğŸ”„ ${round}ë¼ìš´ë“œ ì‹œì‘! í‹€ë¦° ë¬¸ì œë§Œ ë‹¤ì‹œ í’‰ë‹ˆë‹¤.`);
            }
        }

        // ë¬¸ì œ ë¡œë“œ
        currentQ = quizQueue.shift(); 
        
        // UI ì—…ë°ì´íŠ¸
        document.getElementById('round-badge').innerText = round + "ë¼ìš´ë“œ";
        document.getElementById('remain-count').innerText = quizQueue.length + 1;
        document.getElementById('question-display').innerText = currentQ.q;
        
        // ì…ë ¥ì°½ ì´ˆê¸°í™”
        const input = document.getElementById('quiz-input');
        input.value = '';
        input.disabled = false;
        input.focus();
        
        // ë²„íŠ¼ ë° í”¼ë“œë°± ìƒíƒœ ì´ˆê¸°í™”
        document.getElementById('btn-submit').classList.remove('hidden');
        document.getElementById('btn-next').classList.add('hidden');
        document.getElementById('feedback').classList.add('hidden'); 
        document.getElementById('feedback').className = 'feedback-area hidden'; 
    }

    function submitAnswer() {
        const input = document.getElementById('quiz-input');
        const userAns = input.value.trim();
        const correctAns = currentQ.a.trim();
        
        if(!userAns) return; 

        input.disabled = true;

        const feedback = document.getElementById('feedback');
        const feedbackMsg = document.getElementById('feedback-msg');
        const correctShow = document.getElementById('correct-answer-show');
        
        feedback.classList.remove('wrong', 'correct'); 

        // ì •ë‹µ ë¹„êµ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
        if(userAns.toLowerCase() === correctAns.toLowerCase()) {
            // ì •ë‹µ
            feedback.classList.add('correct');
            feedbackMsg.innerText = "ğŸ™†â€â™‚ï¸ ì •ë‹µì…ë‹ˆë‹¤!";
            correctShow.innerText = ""; 
        } else {
            // ì˜¤ë‹µ
            feedback.classList.add('wrong');
            feedbackMsg.innerText = "ğŸ™…â€â™‚ï¸ í‹€ë ¸ìŠµë‹ˆë‹¤.";
            correctShow.innerText = `ì •ë‹µ: ${currentQ.a}`;
            
            // í‹€ë¦° ë¬¸ì œëŠ” ì¬ì‹œë„ íì— ì¶”ê°€
            retryQueue.push(currentQ);
        }
        
        // UI ì—…ë°ì´íŠ¸ (ë²„íŠ¼ ì „í™˜ ë° í”¼ë“œë°± ë°•ìŠ¤ ë³´ì´ê²Œ í•˜ê¸°)
        document.getElementById('btn-submit').classList.add('hidden');
        document.getElementById('btn-next').classList.remove('hidden');
        document.getElementById('btn-next').focus();
        feedback.classList.remove('hidden'); 
    }

    function nextQuestion() {
        loadNextQuestion();
    }
</script>
</body>
</html>
